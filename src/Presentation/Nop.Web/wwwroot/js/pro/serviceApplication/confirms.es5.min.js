"use strict";var PageServiceConfirms=function(n){var t=this,r=n.url,f=n.msg,i=n.model||{},c;i.serviceConfirms=[];i.productTypeId=41;i.selectedServiceConfirms=null;i.depositRequestId=0;Object.defineProperty(t,"model",{get:function(){return i}});var o=new SimplePagination(".pagination-service-confirms-list"),l=$.templates("#template-card-service-confirms-list"),s=$.templates("#template-card-service-confirms-list-response"),a=$.templates("#template-card-service-confirms-list-response-empty"),h=$("#form-service-confirms"),u=$(".content-service-search"),e=u.find(".list-service-confirms-list"),k=$(".content-service-confirms-list-response"),v=null,y=null,p=null,w=(new Date).getTimezoneOffset()/-60;o.onPageChanged=function(n){t.loadServiceConfirmsData(t.setServiceConfirms,n)};t.initDisplayComponent=function(){app.initFormComponent(h)};t.getDepositPayoutDetail=function(n){var t={url:r.getDepositPayoutDetail.format({id:i.selectedServiceConfirms.id}),method:"GET",headers:{"Content-Type":"application/json"}};$.ajax(t).done(n)};t.setDepositPayoutDetail=function(n){if(n&&n.status&&n.status.code===1){n.data.totalRemaining=n.data.deposit.totalAmount-n.data.payout.totalAmount;n.data.deposit.nextDueDate!==null&&(n.data.deposit.formattedNextDueDate=moment.utc(n.data.deposit.nextDueDate).local().format("DD/MM/YYYY"));i.selectedServiceConfirms.depositPayout=n.data;var r=s.render(i.selectedServiceConfirms);u.find(".content-service-confirms-list-response").replaceWith(r);t.loadPayoutRequestTable();t.loadDepositRequestTable();t.loadRefundRequestTable()}else swal({icon:"warning",title:"Fail",text:n.status.message}).then(function(){})};t.loadServiceConfirmsData=function(n,t){var f={keyword:""},o=u.find('[name="dateRangeFilter"]'),h=o.data("daterangepicker"),s,c,e,l;o.length&&o.val()&&(f.startDate=h.startDate,f.endDate=h.endDate);s=10;c=t?t*s:0;i.search=e;e={filter:f.keyword,offset:c,recordSize:s,sorting:null,advancedFilter:f};i.search=e;l={url:r.getServiceConfirms,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(e)};$.ajax(l).done(n)};t.setServiceConfirms=function(n){var r,f;n&&n.status&&n.status.code===1?n.data.data.length>0?($.each(n.data.data,function(n,t){t.tenureStart!==null&&(t.tenureStart=moment(t.tenureStart,"YYYY-MM-DDTHH:mm").format("DD MMM YYYY"));t.tenureEnd!==null&&(t.tenureEnd=moment(t.tenureEnd,"YYYY-MM-DDTHH:mm").format("DD MMM YYYY"));t.startDate!==null&&(t.startDate=moment(t.startDate,"YYYY-MM-DD").format("DD MMM YYYY"));t.endDate!==null&&(t.endDateText=moment(t.endDate,"YYYY-MM-DD").format("DD MMM YYYY"));t.createdOnUTC=moment(t.createdOnUTC,"YYYY-MM-DDTHH:mm").add(w,"hour").format("DD MMM YYYY")}),u.bindText(n.data),e.empty(),o.set(n.data),r=l.render(n.data.data),e.append(r),i.serviceConfirms=i.serviceConfirms.concat(n.data.data),i.selectedServiceConfirms=n.data.data[0],f=s.render(i.selectedServiceConfirms),u.find(".content-service-confirms-list-response").replaceWith(f),t.getDepositPayoutDetail(t.setDepositPayoutDetail),u.find(".card-list-info").removeClass("hidden")):(u.find(".card-list-info").addClass("hidden"),e.empty(),o.set(n.data),u.find(".content-service-confirms-list-response").replaceWith(a)):swal({icon:"warning",title:"Fail",text:n.status.message}).then(function(){})};t.setServiceConfirmsResponse=function(n){var f=$(n).data("entity-id"),e=$.grep(i.serviceConfirms,function(n){return n.id===f}),r;$(n).parent().children(".selected").removeClass("selected");$(n).addClass("selected");i.selectedServiceConfirms=e[0];r=s.render(i.selectedServiceConfirms);u.find(".content-service-confirms-list-response").replaceWith(r);t.loadPayoutRequestTable();t.loadDepositRequestTable();t.loadRefundRequestTable();t.getDepositPayoutDetail(t.setDepositPayoutDetail)};t.serviceApplicationRefund=function(n){var t={url:r.submitRefund.format({id:i.selectedServiceConfirms.id}),method:"POST",headers:{"Content-Type":"application/json"}};$.ajax(t).done(n)};t.onServiceApplicationRefunded=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Refund Request Created Successfully"}).then(function(){t.loadServiceConfirmsData(t.setServiceConfirms)})})};t.handleResponse=function(n,t){n&&n.status&&n.status.code===1?t(n):swal({icon:"warning",title:"Fail",text:n.status.message}).then(function(){})};t.setUserEvent=function(){e.on("click",".card-service-confirms-list",function(){t.setServiceConfirmsResponse(this)});h.find(".submit").on("click",function(n){n.preventDefault();n.stopPropagation();t.loadServiceConfirmsData(t.setServiceConfirms)});h.on("click",".submit-refund",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Create Refund Request?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-secondary",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-primary",closeModal:!0}}}).then(function(n){n&&t.serviceApplicationRefund(t.onServiceApplicationRefunded)})})};t.getModel=function(){return i};t.loadPayoutRequestTable=function(){v=u.find(".tbl-payout-request").DataTable({dom:'rt<"clear">',language:{searchPlaceholder:f.keywordSearch,lengthMenu:"_MENU_",info:f.info,search:"",emptyTable:"No Payout Request is created"},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"createdDateTime"},{data:"payoutCycle"},{data:"formattedAmount"},{data:"statusName"},{data:"lastRemark"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getPayouRequests.format({id:i.selectedServiceConfirms.id}),type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){var u=r.getPayouRequest.replace(/{{id}}/g,n.id),f,t,i;n.action=n.status==0?'<input class="btn btn-primary w-auto" value="Edit" type="button"data-toggle="modal" data-target="#modal-payout-request"   data-keyboard="false" data-backdrop="static"              href="'+u+'" />                      ':'<input class="btn btn-primary w-auto" value="View" type="button"data-toggle="modal" data-target="#modal-payout-request"   data-keyboard="false" data-backdrop="static"              href="'+u+'" />                      ';n.status===2&&(f=r.getInvoiceStatement.replace(/{{id}}/g,n.invoiceId),n.action+='<a class="text-primary" target="_blank"href="'+f+'">[Invoice]<\/a>                      ');n.createdDateTime=moment.utc(n.createdOnUTC).local().format("DD/MM/YYYY");t=moment.utc(n.endDate).local();n.payoutCycle=t.format("YYYY MMM")+" #"+(t.toDate().getDate()<=15?1:2);n.formattedAmount=n.fee.toFixed(2);n.remarks&&n.remarks.length&&(i=n.remarks[n.remarks.length-1],n.lastRemark=i.actorName+": "+i.remark)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]})};t.loadDepositRequestTable=function(){var n=u.find(".tbl-deposit-request");if(n&&n.length){y=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:f.keywordSearch,lengthMenu:"_MENU_",info:f.info,search:"",emptyTable:"No Deposit Request is created"},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"formattedRequestDate"},{data:"formattedDueDate"},{data:"formattedAmount"},{data:"statusText"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getDepositRequests.format({id:i.selectedServiceConfirms.id}),type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){var t,i,u;n.status===1?(t=r.getDepositRequestStatement.replace(/{{id}}/g,n.id),n.action='<a class="text-primary table-action" target="_blank"href="'+t+'"><i class="fas fa-file-alt"><\/i> Statement<\/a>                      ',n.serviceChargeInvoiceId&&(i=r.getInvoiceStatement.replace(/{{id}}/g,n.serviceChargeInvoiceId),n.action+='<a class="text-primary table-action" target="_blank"href="'+i+'">[Invoice]<\/a>')):(u=r.payDepositRequest,n.action='<input class="btn btn-primary w-auto btn-pay-deposit-request" value="Pay" type="button"data-toggle="modal" data-target="#modal-job-application-pay"   data-keyboard="false" data-backdrop="static"              data-id="'+n.id+'"        href="'+u+'" />');n.formattedRequestDate=moment.utc(n.requestDate).local().format("DD/MM/YYYY");n.formattedDueDate=moment.utc(n.dueDate).local().format("DD/MM/YYYY");n.formattedAmount=n.amount.toFixed(2)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]});n.on("click",".btn-pay-deposit-request",function(){var n=$(this),t=n.data("id");i.depositRequestId=t})}};t.loadRefundRequestTable=function(){var n=u.find(".tbl-refund-request");n&&n.length&&(p=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:f.keywordSearch,lengthMenu:"_MENU_",info:f.info,search:"",emptyTable:"No Refund Request is created"},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"createdDateTime"},{data:"refundNumber"},{data:"formattedAmount"},{data:"formattedServiceCharge"},{data:"statusName"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getRefundRequests.format({id:i.selectedServiceConfirms.id}),type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){if(n.action="",n.statusName.toLowerCase()===1){var t=r.getRefundStatement.replace(/{{id}}/g,n.id);n.action+='<a class="text-primary" target="_blank"href="'+t+'">[Refund]<\/a>                      '}n.createdDateTime=moment.utc(n.createdOnUTC).local().format("DD/MM/YYYY");n.formattedAmount="RM "+n.amount.toFixed(2);n.formattedServiceCharge="RM "+n.serviceCharge.toFixed(2)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]}))};t.reloadSelectedEngagement=function(){t.loadServiceConfirmsData(t.setServiceConfirms)};t.reloadPayout=function(){return t.getDepositPayoutDetail(t.setDepositPayoutDetail),!0};c=function(){t.initDisplayComponent();t.loadServiceConfirmsData(t.setServiceConfirms,0);t.setUserEvent()};c()},pageServiceConfirms=new PageServiceConfirms({url:{getServiceConfirms:"/api/pro/serviceApplication/confirms",getPayouRequests:"/api/pro/payoutrequest/serviceapplication/{{id}}",getPayouRequest:"/pro/payoutrequest/{{id}}",getDepositRequests:"/api/pro/depositrequest/serviceapplication/{{id}}",payDepositRequest:"/pro/order/PayDepositRequest",getDepositRequestStatement:"/pro/statement/Pdf/Deposit/{{id}}",getInvoiceStatement:"/pro/statement/Pdf/Invoice/{{id}}",getRefundStatement:"/pro/statement/Pdf/Refund/{{id}}",getDepositPayoutDetail:"/api/pro/serviceApplication/{{id}}/depositPayout",getRefundRequests:"/api/pro/refundrequest/serviceapplication/{{id}}",submitRefund:"/api/pro/serviceApplication/{{id}}/refund"},msg:{keywordSearch:"search by keyword",info:"this is info"}});