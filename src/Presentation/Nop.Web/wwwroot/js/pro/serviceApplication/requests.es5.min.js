"use strict";var PageServiceRequests=function(n){function v(n){n.find(".btn-payment").on("click",function(i){i.preventDefault();i.stopPropagation();t.validationForm(n)&&t.generatePaymentLink(t.redirectToPaymentGateway)})}var t=this,u=n.url,i=n.model||{},s;i.serviceRequests=[];var e=new SimplePagination(".pagination-service-requests-list"),h=$.templates("#template-card-service-requests-empty"),c=$.templates("#template-card-service-requests-list"),o=$.templates("#template-card-service-requests-list-response"),l=$.templates("#template-card-service-requests-list-pay"),r=$(".content-service-search"),f=r.find(".list-service-requests-list"),y=$(".content-service-requests-list-response"),a=(new Date).getTimezoneOffset()/-60;e.onPageChanged=function(n){t.loadServiceRequestsData(t.setServiceRequests,n)};t.updateServiceBuyerRead=function(n,t){if(n.requesterIsRead)return!0;n.requesterIsRead=!0;var i={url:u.updateServiceBuyerRead.format(n),method:"PUT",headers:{"Content-Type":"application/json"},background:!0};$.ajax(i).done(t)};t.updateServiceBuyerReadResponse=function(){};t.loadServiceRequestsData=function(n,t){var r={keyword:""},f=10,s=t?t*f:0,e={filter:r.keyword,offset:s,recordSize:f,sorting:null,advancedFilter:r},o;i.search=e;o={url:u.getServiceRequests,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(e)};$.ajax(o).done(n)};t.generatePaymentLink=function(n){var t={url:u.generatePaymentLink,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({id:i.orderId})};$.ajax(t).done(n)};t.redirectToPaymentGateway=function(n){t.handleResponse(n,function(n){window.location.href=n.data.paymentURL})};t.setServiceRequests=function(n){var u,s,l;if(n&&n.status&&n.status.code===1)if(n.data.data.length>0){f.empty();e.set(n.data);$.each(n.data.data,function(n,t){t.tenureStart!==null&&(t.tenureStart=moment(t.tenureStart,"YYYY-MM-DDTHH:mm").add(0,"hour").format("DD MMM YYYY"));t.tenureEnd!==null&&(t.tenureEnd=moment(t.tenureEnd,"YYYY-MM-DDTHH:mm").add(0,"hour").format("DD MMM YYYY"));t.tenureStart!==null&&(t.startDate=moment(t.startDate,"YYYY-MM-DD").add(0,"hour").format("DD MMM YYYY"));t.createdOnUTC=moment(t.createdOnUTC,"YYYY-MM-DDTHH:mm").add(a,"hour").format("DD MMM YYYY")});r.bindText(n.data);u=c.render(n.data.data);f.append(u);i.serviceRequests=i.serviceRequests.concat(n.data.data);i.selectedServiceRequests=n.data.data[0];t.updateServiceBuyerRead(i.selectedServiceRequests,t.updateServiceBuyerReadResponse);s=o.render(i.selectedServiceRequests);r.find(".content-service-requests-list-response").replaceWith(s);l=$(".area-expertise");i.selectedServiceRequests.serviceProfile.serviceExpertises.forEach(function(n){l.append("<span class='badge badge-pill badge-primary'>"+n.name+"<\/span>&nbsp;")});r.find(".btn-decline").on("click",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Decline?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-fail",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-success",closeModal:!0}}}).then(function(n){n&&t.declineService(t.responseDeclineService)})});r.find(".btn-accept").on("click",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Accept?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-fail",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-success",closeModal:!0}}}).then(function(n){n&&t.acceptService(t.responseAcceptService)})});r.find(".btn-pay").on("click",function(n){n.preventDefault();n.stopPropagation();t.createOrder(t.createOrderResponse)})}else r.replaceWith(h);else swal({icon:"warning",title:"Fail",text:n.status.message}).then(function(){})};t.setServiceRequestsResponse=function(n){var e=$(n).data("entity-id"),s=$.grep(i.serviceRequests,function(n){return n.id===e}),u,f;$(n).parent().children(".selected").removeClass("selected");$(n).addClass("selected");i.selectedServiceRequests=s[0];t.updateServiceBuyerRead(i.selectedServiceRequests,t.updateServiceBuyerReadResponse);u=o.render(i.selectedServiceRequests);r.find(".content-service-requests-list-response").replaceWith(u);f=$(".area-expertise");i.selectedServiceRequests.serviceProfile.serviceExpertises.forEach(function(n){f.append("<span class='badge badge-pill badge-primary'>"+n.name+"<\/span>&nbsp;")})};t.handleResponse=function(n,t){n&&n.status&&n.status.code===1?t(n):swal({icon:"warning",title:"Fail",text:n.status.message}).then(function(){})};t.createOrder=function(n){var t={productTypeId:41,refId:i.selectedServiceRequests.id},r={url:u.createOrder,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(t)};$.ajax(r).done(n)};t.createOrderResponse=function(n){var u,t,f,e;i.orderId=n.data.id;u=n.data;t={customOrderNumber:null,orderTotal:0,serviceFeeAmount:0,escrowAmount:0,serviceFeeRateType:null,serviceFeeRateAmount:0};t.customOrderNumber=u.customOrderNumber;t.orderTotal=u.orderTotal;u.orderItems.forEach(function(n){n.productTypeId===4&&(t.serviceFeeAmount=n.price);n.productTypeId===41&&n.price>0&&(t.escrowAmount=n.price);n.productTypeId===41&&n.price<0?t.offsetOrderItem=n:t.offsetAmount=null});u.moreInfo!==null&&(f=JSON.parse(u.moreInfo),t.serviceFeeRateType=f.ServiceFeeType,t.serviceFeeRateAmount=parseFloat(f.ServiceFeeAmount)*100);e=l.render(t);r.find(".content-service-requests-list-response").replaceWith(e);v(r.find("#form-request-payment"));app.initFormComponent(r.find(".content-service-requests-list-response"))};t.validationForm=function(n){return n.valid()&&!0};t.acceptService=function(n){var t=i.selectedServiceRequests.id,r={id:t},f={url:u.acceptServiceApplication,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(r)};$.ajax(f).done(n)};t.responseAcceptService=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Service Request Accepted Succesfully "}).then(function(){location.reload()})})};t.declineService=function(n){var t=i.selectedServiceRequests.id,r={id:t},f={url:u.declineServiceApplication,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(r)};$.ajax(f).done(n)};t.responseDeclineService=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Service Request Declined Successfully"}).then(function(){location.reload()})})};t.paymentService=function(n){var t=i.orderId,r={url:u.updateOrder.format({id:t}),method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({orderStatusId:30,paymentStatusId:30})};$.ajax(r).done(n)};t.responsePaymentService=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Service Request Paid Succesfully"}).then(function(){location.reload()})})};t.setUserEvent=function(){f.on("click",".card-service-requests-list",function(){t.setServiceRequestsResponse(this);r.find(".btn-decline").on("click",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Decline?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-fail",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-success",closeModal:!0}}}).then(function(n){n&&t.declineService(t.responseDeclineService)})});r.find(".btn-accept").on("click",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Accept?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-fail",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-success",closeModal:!0}}}).then(function(n){n&&t.acceptService(t.responseAcceptService)})});r.find(".btn-pay").on("click",function(n){n.preventDefault();n.stopPropagation();t.createOrder(t.createOrderResponse)})})};t.getModel=function(){return i};s=function(){t.loadServiceRequestsData(t.setServiceRequests);t.setUserEvent()};s()},pageServiceRequests=new PageServiceRequests({url:{getServiceRequests:"/api/pro/serviceApplication/requests",acceptServiceApplication:"/api/pro/serviceApplication/accept",declineServiceApplication:"/api/pro/serviceApplication/decline",createOrder:"/api/pro/order/0",updateOrder:"/api/pro/order/{{id}}",updateServiceBuyerRead:"/api/pro/serviceApplication/{{id}}/buyer/read",generatePaymentLink:"/api/pro/payment"}});