"use strict";var PageJobApplicant=function(n){var t=this,r=n.url,u=n.msg,h,i,l;$.templates({tmplContentJobEngagement:"#tmpl-content-job-engagement"});var c=$("#form-job-hired"),f=$(".content-job-engagement"),e=null,o=null,s=null;Object.defineProperty(t,"model",{get:function(){return i}});h=new SimplePagination;h.onPageChanged=function(n){t.getJobEngagement(t.onGetJobEngagement,n)};i={pagination:h,depositRequestId:0,productTypeId:5,jobEngagements:{totalCount:0},selectedJobEngagement:null,setJobEngagements:function(n){h.set(n);$.each(n.data,function(n,t){if(t.startDate&&(t.startDateText=moment(t.startDate,"YYYY-MM-DD").format("DD MMM YYYY")),t.endDate&&(t.endDateText=moment(t.endDate,"YYYY-MM-DD").format("DD MMM YYYY")),t.jobType===3&&t.jobMilestones.length>0&&(t.startMilestoneText=t.jobMilestones[0].description,t.endMilestoneId!==null)){var i=t.jobMilestones.filter(function(n){return n.id===t.endMilestoneId});t.endMilestoneText=i[0].description}});$.observable(this.jobEngagements).setProperty("data",n.data);$.observable(this.jobEngagements).setProperty("totalCount",n.totalCount);this.jobEngagements.data&&this.jobEngagements.data.length>0&&this.setSelectedJobEngagement(this.jobEngagements.data[0])},setSelectedJobEngagement:function(n){var i=$.grep(this.jobEngagements.data,function(n){return n.selected===!0});i.length>0&&$.observable(i[0]).setProperty("selected",!1);$.observable(this).setProperty("selectedJobEngagement",null);$.observable(this).setProperty("selectedJobEngagement",n);$.observable(n).setProperty("selected",!0);$("input.rating[type=number], div.rating").each(function(){$(this).rating({iconLib:"",inactiveIcon:"far fa-star",activeIcon:"fa fa-star"})});t.getDepositPayoutDetail(t.setDepositPayoutDetail)},updateSelectedJobEngagementStatus:function(n,i){if(i!==this.selectedJobEngagement.jobApplicationStatus){var r=this.selectedJobEngagement.id;swal({icon:"warning",title:"Are you sure to update the status to "+n+"?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-fail",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-success",closeModal:!0}}}).then(function(n){n&&t.updateJobEngagementStatus(t.onUpdateJobEngagementStatus,r,i)})}}};t.initDisplayComponent=function(){app.initFormComponent(c)};t.getJobEngagement=function(n,t){var u={keyword:"",jobApplicationStatus:[6,7,12,13,16,17,18,19]},e=f.find('[name="dateRangeFilter"]'),o=e.data("daterangepicker"),c;e.length&&e.val()&&(u.startDate=o.startDate,u.endDate=o.endDate);var s=10,l=t?t*s:0,h={filter:u.keyword,offset:l,recordSize:s,sorting:null,advancedFilter:u};i.search=h;c={url:r.getJobEngagement,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(h)};$.ajax(c).done(n)};t.updateJobEngagementStatus=function(n,t,i){var u={},f;u.JobApplicationStatus=i;f={url:r.updateJobEngagementStatus.format({id:t}),method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(u)};$.ajax(f).done(n)};t.jobApplicationRefund=function(n){var t={url:r.submitRefund.format({id:i.selectedJobEngagement.id}),method:"POST",headers:{"Content-Type":"application/json"}};$.ajax(t).done(n)};t.updateJobEngagementRead=function(){if(i.selectedJobEngagement.isOrganizationRead!==!0){var n={url:r.updateJobEngagementRead.format({id:i.selectedJobEngagement.id}),background:!0,method:"PUT",headers:{"Content-Type":"application/json"}};$.ajax(n)}};t.handleResponse=function(n,t){n&&n.status&&n.status.code===1?t(n):swal({icon:"warning",title:"Fail",text:n.status.message})};t.onGetJobEngagement=function(n){t.handleResponse(n,function(n){i.setJobEngagements(n.data)})};t.onUpdateJobEngagementStatus=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Applicant Status Updated Successfully"}).then(function(){t.reloadSelectedEngagement()})})};t.onJobApplicationRefunded=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Refund Request Created Successfully"}).then(function(){t.reloadSelectedEngagement()})})};t.loadPayoutRequestTable=function(){e&&e.context[0].nTable.parentNode&&e.destroy();var n=f.find(".tbl-payout-request");n&&n.length&&(e=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:u.keywordSearch,lengthMenu:"_MENU_",info:u.info,search:"",emptyTable:"No Payout Request is created"},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"createdDateTime"},{data:"payoutCycle"},{data:"formattedAmount"},{data:"statusName"},{data:"lastRemark"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getPayoutRequests.format({id:i.selectedJobEngagement.id}),type:"post",background:!0,data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){var f=r.getPayoutRequest.replace(/{{id}}/g,n.id),u,t,i;n.action='<input class="btn btn-primary w-auto" value="Edit" type="button"data-toggle="modal" data-target="#modal-payout-request"   data-keyboard="false" data-backdrop="static"              href="'+f+'" />                      ';n.status===2&&(u=r.getPayoutInvoiceStatement.replace(/{{id}}/g,n.invoiceId),n.action+='<a class="text-primary table-action d-inline-block" target="_blank"href="'+u+'">[Invoice]<\/a>                      ');n.createdDateTime=moment.utc(n.createdOnUTC).local().format("DD/MM/YYYY");n.endDate?(t=moment.utc(n.endDate).local(),n.payoutCycle=t.format("YYYY MMM")+" #"+(t.toDate().getDate()<=15?1:2)):n.payoutCycle="Phase "+n.jobMilestonePhase+" - "+n.jobMilestoneName;n.formattedAmount=n.fee.toFixed(2);n.remarks&&n.remarks.length&&(i=n.remarks[n.remarks.length-1],n.lastRemark=i.actorName+": "+i.remark)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]}))};t.loadDepositRequestTable=function(){o&&o.context[0].nTable.parentNode&&o.destroy();var n=f.find(".tbl-deposit-request");if(n&&n.length){o=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:u.keywordSearch,lengthMenu:"_MENU_",info:u.info,search:"",emptyTable:"No Deposit Request is created"},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"formattedRequestDate"},{data:"formattedDueDate"},{data:"formattedAmount"},{data:"statusText"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getDepositRequests.format({id:i.selectedJobEngagement.id}),background:!0,type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){var t,i,u;n.status===1?(t=r.getDepositRequestStatement.replace(/{{id}}/g,n.id),n.action='<a class="text-primary table-action" target="_blank"href="'+t+'"><i class="fas fa-file-alt"><\/i> Statement<\/a>                      ',n.serviceChargeInvoiceId&&(i=r.getInvoiceStatement.replace(/{{id}}/g,n.serviceChargeInvoiceId),n.action+='<a class="text-primary table-action" target="_blank"href="'+i+'"><i class="fas fa-file-alt"><\/i>Invoice<\/a>')):(u=r.payDepositRequest,n.action='<input class="btn btn-primary w-auto btn-pay-deposit-request" value="Pay" type="button"data-toggle="modal" data-target="#modal-job-application-pay"   data-keyboard="false" data-backdrop="static"              data-id="'+n.id+'"        href="'+u+'" />                      ');n.formattedRequestDate=moment.utc(n.requestDate).local().format("DD/MM/YYYY");n.formattedDueDate=moment.utc(n.dueDate).local().format("DD/MM/YYYY");n.formattedAmount=n.amount.toFixed(2)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]});n.on("click",".btn-pay-deposit-request",function(){var n=$(this),t=n.data("id");i.depositRequestId=t})}};t.loadRefundRequestTable=function(){s&&s.context[0].nTable.parentNode&&s.destroy();var n=f.find(".tbl-refund-request");n&&n.length&&(s=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:u.keywordSearch,lengthMenu:"_MENU_",info:u.info,search:""},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"createdDateTime"},{data:"refundNumber"},{data:"formattedAmount"},{data:"formattedServiceCharge"},{data:"statusName"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getRefundRequests.format({id:i.selectedJobEngagement.id}),type:"post",data:function(n){n.customFilter={}},background:!0,dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){if(n.action="",n.statusName.toLowerCase()===1){var t=r.getRefundStatement.replace(/{{id}}/g,n.id);n.action+='<a class="text-primary" target="_blank"href="'+t+'">[Refund]<\/a>                      '}n.createdDateTime=moment.utc(n.createdOnUTC).local().format("DD/MM/YYYY");n.formattedAmount="RM "+n.amount.toFixed(2);n.formattedServiceCharge="RM "+n.serviceCharge.toFixed(2)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]}))};t.getDepositPayoutDetail=function(n){var t={url:r.getDepositPayoutDetail.format({id:i.selectedJobEngagement.id}),background:!0,method:"GET",headers:{"Content-Type":"application/json"}};$.ajax(t).done(n)};t.setDepositPayoutDetail=function(n){t.handleResponse(n,function(n){n.data.totalRemaining=n.data.deposit.totalAmount-n.data.payout.totalAmount;n.data.deposit.nextDueDate!==null&&(n.data.deposit.formattedNextDueDate=moment.utc(n.data.deposit.nextDueDate).local().format("DD/MM/YYYY"));$.observable(i.selectedJobEngagement).setProperty("depositPayout",n.data);t.updateJobEngagementRead();t.loadPayoutRequestTable();t.loadDepositRequestTable();t.loadRefundRequestTable()})};t.reloadSelectedEngagement=function(){t.getJobEngagement(t.onGetJobEngagement)};t.reloadPayout=function(){return t.getDepositPayoutDetail(t.setDepositPayoutDetail),!0};t.onJobApplicationStartDateUpdated=function(){i.selectedJobEngagement.isEscrow?i.selectedJobEngagement===3?$("#modal-project-deposit-request .modal-content").load(r.payProjectDepositRequest,function(){$("#modal-project-deposit-request").modal({show:!0})}):$("#modal-job-application-pay .modal-content").load(r.payJobEscrow,function(){$("#modal-job-application-pay").modal({show:!0})}):i.updateSelectedJobEngagementStatus("Hire",6)};t.getModel=function(){return i};t.setUserEvent=function(){c.on("click",".submit",function(n){n.preventDefault();n.stopPropagation();t.getJobEngagement(t.onGetJobEngagement)});c.on("click",".submit-refund",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Create Refund Request?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-secondary",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-primary",closeModal:!0}}}).then(function(n){n&&t.jobApplicationRefund(t.onJobApplicationRefunded)})})};l=function(){$.templates.tmplContentJobEngagement.link(".content-job-engagement",i);t.initDisplayComponent();t.setUserEvent();t.getJobEngagement(t.onGetJobEngagement)};l()},pageJobApplicant=new PageJobApplicant({url:{getJobEngagement:"/api/pro/jobApplication/applicants",updateJobEngagementStatus:"/api/pro/jobApplication/{{id}}",getPayoutRequests:"/api/pro/payoutrequest/jobapplication/{{id}}",getDepositRequests:"/api/pro/depositrequest/jobapplication/{{id}}",getPayoutRequest:"/pro/payoutrequest/{{id}}",getDepositRequestStatement:"/pro/statement/Pdf/deposit/{{id}}",payJobEscrow:"/pro/order/payjobescrow",payProjectDepositRequest:"/pro/order/payProjectDepositRequest",payDepositRequest:"/pro/order/PayDepositRequest",getDepositPayoutDetail:"/api/pro/jobApplication/{{id}}/depositPayout",updateJobEngagementRead:"/api/pro/jobApplication/{{id}}/org/read",getRefundStatement:"/pro/statement/Pdf/Refund/{{id}}",getRefundRequests:"/api/pro/refundrequest/jobapplication/{{id}}",submitRefund:"/api/pro/jobApplication/{{id}}/refund",getPayoutInvoiceStatement:"/pro/statement/Pdf/invoice/{{id}}"},msg:{keywordSearch:"search by keyword",info:"this is info"}});