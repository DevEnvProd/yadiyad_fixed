"use strict";var PageRequestService=function(n){var f=(new Date).getTimezoneOffset()/-60,r=this,o=n.url,t={id:0,engagementNo:null,engagementDurationType:0,productTypeId:0,referId:0,engagement:null},u=null,e,i,s;Object.defineProperty(r,"timeSheetScheduler",{get:function(){return u}});e=$(".content-payout-request");i=e.find(".form-payout-request");t.id=i.data("id");r.loadModel=function(){window.pageServiceHires?(t.engagement=pageServiceHires.model.selectedServiceHires,t.productTypeId=pageServiceHires.model.productTypeId,t.engagementNo=t.engagement.code,t.refId=t.engagement.id,t.engagementDurationType=t.engagement.serviceProfileServiceTypeId):window.pageServiceConfirms?(t.engagement=pageServiceConfirms.model.selectedServiceConfirms,t.productTypeId=pageServiceConfirms.model.productTypeId,t.engagementNo=t.engagement.code,t.refId=t.engagement.id,t.engagementDurationType=t.engagement.serviceProfileServiceTypeId):window.pageJobApplications?(t.engagement=pageJobApplications.model.selectedJobApplication,t.productTypeId=pageJobApplications.model.productTypeId,t.engagementNo=t.engagement.code,t.refId=t.engagement.id,t.engagementDurationType=t.engagement.serviceProfileServiceTypeId):window.pageJobApplicant&&(t.engagement=pageJobApplicant.model.selectedJobEngagement,t.productTypeId=pageJobApplicant.model.productTypeId,t.engagementNo=t.engagement.code,t.refId=t.engagement.id,t.engagementDurationType=t.engagement.serviceProfileServiceTypeId);r.getPayoutRequest(r.onGetPayoutRequestResponse)};r.loadUIComponent=function(){app.initFormComponent(i)};r.getPayoutRequest=function(n){var i={url:o.getPayoutRequest.format(t),method:"GET",headers:{"Content-Type":"application/json"}};$.ajax(i).done(n)};r.createPayoutRequest=function(n,u){var f=app.getFormValue(i),s=r.getScheduleCollection(),e;f.TimeSheetJson=JSON.stringify(s);f.refId=t.refId;f.productTypeId=t.productTypeId;f.id=t.id;u&&(f.status=u);e={url:o.createPayoutRequest,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(f)};$.ajax(e).done(n)};r.handleResponse=function(n,t){n&&n.status&&n.status.code===1?t(n):swal({icon:"warning",title:"Fail",text:n.status.message}).then(function(){})};r.onCreatePayoutRequestResponse=function(n){r.handleResponse(n,function(){swal({icon:"success",title:"The new info is processed."}).then(function(){var t=e.closest(".modal"),n;t?(t.modal("hide"),n=null,window.pageServiceHires?n=pageServiceHires:window.pageServiceConfirms?n=pageServiceConfirms:window.pageJobApplications?n=pageJobApplications:window.pageJobApplicant&&(n=pageJobApplicant),n.reloadPayout&&n.reloadPayout()||n.reloadSelectedEngagement()):location.reload()})})};r.onGetPayoutRequestResponse=function(n){r.handleResponse(n,function(n){var r=n.data,e=!1,h="weekly",c,l,o,a,s,v;if(t.engagementDurationType===2&&(h="monthly"),r.serviceEngagementNumber=t.engagementNo,app.setFormValue(i,r),(window.pageServiceHires||window.pageJobApplications)&&(r.id===0||r.status===-2)?i.find(".btn-submit").removeClass("hidden"):(window.pageServiceConfirms||window.pageJobApplicant)&&r.id!==0&&r.status===0?(i.find(".secProvider [name]").each(function(n,t){$(t).attr("readonly",!0)}),e=!0,i.find('[name="attachmentDownloadId"]').closest(".nopui-file-attachment").addClass("readonly"),i.find('[name="attachmentDownloadId"]').closest(".nopui-file-attachment").find(".fa-file-alt").css("display",""),i.find('[name="attachmentDownloadId"]').closest(".nopui-file-attachment").find(".lbl-file-name").css("display","none"),i.find(".btn-more-info").removeClass("hidden"),i.find(".btn-approve").removeClass("hidden")):(i.find("[name]").each(function(n,t){$(t).attr("readonly",!0)}),e=!0,i.find('[name="attachmentDownloadId"]').closest(".nopui-file-attachment").addClass("readonly"),i.find('[name="attachmentDownloadId"]').closest(".nopui-file-attachment").find(".fa-file-alt").css("display",""),i.find('[name="attachmentDownloadId"]').closest(".nopui-file-attachment").find(".lbl-file-name").css("display","none"),i.find(".btn-cancel").text("Back")),u=new WeeklyScheduler("#timesheet",e,h),r.workingTimeSlots&&(r.workingTimeSlots.forEach(function(n){n.start=moment(n.startDateTime,"YYYY-MM-DDTHH:mm").add(f,"hour").toDate();n.end=moment(n.endDateTime,"YYYY-MM-DDTHH:mm").add(f,"hour").toDate();n.isReadOnly=e}),u.setSchedule(r.workingTimeSlots,!0)),r.startDate&&r.endDate&&(c=moment(r.startDate,"YYYY-MM-DDTHH:mm").toDate(),l=moment(r.endDate,"YYYY-MM-DDTHH:mm").toDate(),u.setEnabledDateRange(h,c,l)),r.isProrated){o=i.find(".secProrated").find('[name="proratedWorkDuration"]');a=i.find(".secProrated").find('[name="proratedPayout"]');o.on("change",function(){var n=0,u=(t.engagement.serviceProfileServiceFee||t.engagement.payAmount)+(t.engagement.serviceProfileOnsiteFee||0),i,r;t.engagement.serviceProfileServiceTypeId===1||t.engagement.jobType===1?n=new Decimal(t.engagement.required||t.engagement.jobRequired).times(4).dividedBy(2):(t.engagement.serviceProfileServiceTypeId===2||t.engagement.jobType===2)&&(n=new Decimal(t.engagement.required||t.engagement.jobRequired).dividedBy(2));i=parseFloat(o.val()||0);r=new Decimal(u).times(n).times(new Decimal(i).dividedBy(n));a.val(r.toFixed(2))});o.trigger("change")}else i.find(".secProrated").hide();r.jobMilestoneId?i.find(".secNonProjectBased").hide():i.find(".secProjectBased").hide();r.remarks&&r.remarks.length&&(s="",$.each(r.remarks,function(n,t){var i=moment(t.remarkDate,"YYYY-MM-DDTHH:mm").add(f,"hour").format("DD MMM YYYY hh:mm A");s+=(s?"<br/>":"")+i+" - "+t.actorName+": "+t.remark}),i.find(".remarks-history").html(s),i.find(".remarks-history").closest(".form-group").removeClass("hidden"));r.id&&r.statusName&&(v=r.status===-3?"badge-gray":r.status===-2?"badge-secondary":r.status===-1?"badge-danger":r.status===0?"badge-gray":r.status===1?"badge-success":r.status===2?"badge-primary":"",i.find(".secStatus .badge-status").addClass(v),i.find(".secStatus .badge-status").text(r.statusName),i.find(".secStatus").removeClass("hidden"))})};r.getScheduleCollection=function(){var n=[];return $.each(u.Calendar._controller.schedules.items,function(t,i){var r={startDateTime:i.start.toDate(),endDateTime:i.end.toDate()};n.push(r)}),n};r.setUserEvent=function(){i.find("button[type=submit]").on("click",function(n){(n.preventDefault(),n.stopPropagation(),i.valid()!==!1)&&r.createPayoutRequest(r.onCreatePayoutRequestResponse,0)});i.find(".btn-more-info").on("click",function(n){(n.preventDefault(),n.stopPropagation(),i.valid()!==!1)&&r.createPayoutRequest(r.onCreatePayoutRequestResponse,-2)});i.find(".btn-approve").on("click",function(n){(n.preventDefault(),n.stopPropagation(),i.valid()!==!1)&&r.createPayoutRequest(r.onCreatePayoutRequestResponse,1)})};s=function(){r.loadModel();r.loadUIComponent();r.setUserEvent()};s()},pageRequestService=new PageRequestService({url:{createPayoutRequest:"/api/pro/payoutrequest",getPayoutRequest:"/api/pro/payoutrequest/{{id}}?refId={{refId}}&productTypeId={{productTypeId}}"}});