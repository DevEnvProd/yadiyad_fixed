"use strict";var PageJobApplicant=function(n){var t=this,r=n.url,u=n.msg,h=(new Date).getTimezoneOffset()/-60,e,i,s;$.templates({tmplContentJobEngagement:"#tmpl-content-job-engagement"});var o=$("#form-job-applications"),f=$(".content-job-engagement"),c=null,l=null,a=null;Object.defineProperty(t,"model",{get:function(){return i}});e=new SimplePagination;e.onPageChanged=function(n){t.getJobEngagement(t.onGetJobEngagement,n)};i={pagination:e,depositRequestId:0,productTypeId:5,jobEngagements:{totalCount:0},selectedJobEngagement:null,setJobEngagements:function(n){e.set(n);$.each(n.data,function(n,t){t.serviceIndividualProfile&&t.serviceIndividualProfile.dateOfBirth&&(t.serviceIndividualProfile.dateOfBirthText=moment(t.serviceIndividualProfile.dateOfBirth,"YYYY-MM-DDTHH:mm:ss").format("DD MMM YYYY"));t.createdOn=moment(t.createdOnUTC,"YYYY-MM-DDTHH:mm").add(h,"hour").format("DD MMM YYYY")});$.observable(this.jobEngagements).setProperty("data",n.data);$.observable(this.jobEngagements).setProperty("totalCount",n.totalCount);this.jobEngagements.data&&this.jobEngagements.data.length>0&&this.setSelectedJobEngagement(this.jobEngagements.data[0])},setSelectedJobEngagementStatus:function(n){var t=i.selectedJobEngagement,r,u,f;t.jobApplicationStatus=n;r=this.jobEngagements.data;u=$.grep(r,function(n){return n.id===t.id});u[0].jobApplicationStatus=n;f=this.jobEngagements.totalCount;$.observable(this.jobEngagements).setProperty("data",[]);$.observable(this.jobEngagements).setProperty("totalCount",0);$.observable(this.jobEngagements).setProperty("data",r);$.observable(this.jobEngagements).setProperty("totalCount",f);this.setSelectedJobEngagement(t)},setSelectedJobEngagement:function(n){var i=$.grep(this.jobEngagements.data,function(n){return n.selected===!0});i.length>0&&$.observable(i[0]).setProperty("selected",!1);$.observable(this).setProperty("selectedJobEngagement",null);$.observable(this).setProperty("selectedJobEngagement",n);$.observable(n).setProperty("selected",!0);t.getDepositPayoutDetail(t.setDepositPayoutDetail)},updateSelectedJobEngagementStatus:function(n,i){if(i!==this.selectedJobEngagement.jobApplicationStatus){var r=this.selectedJobEngagement.id;swal({icon:"warning",title:"Are you sure to update the status to "+n+"?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-fail",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-success",closeModal:!0}}}).then(function(n){n&&t.updateJobEngagementStatus(function(){t.onUpdateJobEngagementStatus(i)},r,i)})}}};t.initDisplayComponent=function(){app.initFormComponent(o)};t.setData=function(){var t=window.location.href,n=t.split("/");i.jobId=parseInt(n[n.length-2])||0};t.getJobEngagement=function(n,t){var u={keyword:"",jobProfileId:i.jobId},e=f.find('[name="dateRangeFilter"]'),o=e.data("daterangepicker"),c;e.length&&e.val()&&(u.startDate=o.startDate,u.endDate=o.endDate);var s=10,l=t?t*s:0,h={filter:u.keyword,offset:l,recordSize:s,sorting:null,advancedFilter:u};i.search=h;c={url:r.getJobEngagement,method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(h)};$.ajax(c).done(n)};t.updateJobEngagementStatus=function(n,t,i){var u={},f;u.JobApplicationStatus=i;f={url:r.updateJobEngagementStatus.format({id:t}),method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify(u)};$.ajax(f).done(n)};t.jobApplicationRefund=function(n){var t={url:r.submitRefund.format({id:i.selectedJobEngagement.id}),method:"POST",headers:{"Content-Type":"application/json"}};$.ajax(t).done(n)};t.handleResponse=function(n,t){n&&n.status&&n.status.code===1?t(n):swal({icon:"warning",title:"Fail",text:n.status.message})};t.onGetJobEngagement=function(n){t.handleResponse(n,function(n){i.setJobEngagements(n.data)})};t.onUpdateJobEngagementStatus=function(n){swal({icon:"success",title:"Applicant Status Updated Successfully"}).then(function(){n===6?window.location.href="/pro/jobapplication/hired":t.reloadSelectedEngagement(n)})};t.onJobApplicationRefunded=function(n){t.handleResponse(n,function(){swal({icon:"success",title:"Refund Request Created Successfully"}).then(function(){})})};t.loadPayoutRequestTable=function(){var n=f.find(".tbl-payout-request");n&&n.length&&(c=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:u.keywordSearch,lengthMenu:"_MENU_",info:u.info,search:""},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"createdDateTime"},{data:"payoutCycle"},{data:"formattedAmount"},{data:"statusName"},{data:"lastRemark"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getPayoutRequests.format({id:i.selectedJobEngagement.id}),type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){var u=r.getPayoutRequest.replace(/{{id}}/g,n.id),t,i;n.action='<input class="btn btn-primary w-auto" value="View" type="button"data-toggle="modal" data-target="#modal-payout-request"   data-keyboard="false" data-backdrop="static"              href="'+u+'" />                      ';n.createdDateTime=moment.utc(n.createdOnUTC).local().format("DD/MM/YYYY");n.endDate?(t=moment.utc(n.endDate).local(),n.payoutCycle=t.format("YYYY MMM")+" #"+(t.toDate().getDate()<=15?1:2)):n.payoutCycle="Phase "+n.jobMilestonePhase+" - "+n.jobMilestoneName;n.formattedAmount=n.fee.toFixed(2);n.remarks&&n.remarks.length&&(i=n.remarks[n.remarks.length-1],n.lastRemark=i.actorName+": "+i.remark)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]}))};t.loadDepositRequestTable=function(){var n=f.find(".tbl-deposit-request");if(n&&n.length){l=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:u.keywordSearch,lengthMenu:"_MENU_",info:u.info,search:""},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"formattedRequestDate"},{data:"formattedDueDate"},{data:"formattedAmount"},{data:"statusText"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getDepositRequests.format({id:i.selectedJobEngagement.id}),type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){var t,i,u;n.status===1?(t=r.getDepositRequestStatement.replace(/{{id}}/g,n.id),n.action='<a class="text-primary table-action" target="_blank"href="'+t+'"><i class="fas fa-file-alt"><\/i><\/a>                      ',n.serviceChargeInvoiceId&&(i=r.getInvoiceStatement.replace(/{{id}}/g,n.serviceChargeInvoiceId),n.action+='<a class="text-primary table-action" target="_blank"href="'+i+'">[Invoice]<\/a>')):(u=r.payDepositRequest,n.action='<input class="btn btn-primary w-auto btn-pay-deposit-request" value="Pay" type="button"data-toggle="modal" data-target="#modal-job-application-pay"   data-keyboard="false" data-backdrop="static"              data-id="'+n.id+'"        href="'+u+'" />                      ');n.formattedRequestDate=moment.utc(n.requestDate).local().format("DD/MM/YYYY");n.formattedDueDate=moment.utc(n.dueDate).local().format("DD/MM/YYYY");n.formattedAmount=n.amount.toFixed(2)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]});n.on("click",".btn-pay-deposit-request",function(){var n=$(this),t=n.data("id");i.depositRequestId=t})}};t.loadRefundRequestTable=function(){var n=f.find(".tbl-refund-request");n&&n.length&&(a=n.DataTable({dom:'rt<"clear">',language:{searchPlaceholder:u.keywordSearch,lengthMenu:"_MENU_",info:u.info,search:""},processing:!1,serverSide:!0,autoWidth:!0,scrollX:!0,columns:[{data:"createdDateTime"},{data:"refundNumber"},{data:"formattedAmount"},{data:"formattedServiceCharge"},{data:"statusName"},{data:"action"}],ordering:!1,order:[[0,"asc"]],ajax:{url:r.getRefundRequests.format({id:i.selectedJobEngagement.id}),type:"post",data:function(n){n.customFilter={}},dataFilter:function(n){var t=$.parseJSON(n),i=t.data.data;return i.forEach(function(n){if(n.action="",n.statusName.toLowerCase()===1){var t=r.getRefundStatement.replace(/{{id}}/g,n.id);n.action+='<a class="text-primary" target="_blank"href="'+t+'">[Refund]<\/a>                      '}n.createdDateTime=moment.utc(n.createdOnUTC).local().format("DD/MM/YYYY");n.formattedAmount="RM "+n.amount.toFixed(2);n.formattedServiceCharge="RM "+n.serviceCharge.toFixed(2)}),JSON.stringify(t.data)}},lengthMenu:[[10,25,50,-1],[10,25,50]]}))};t.getDepositPayoutDetail=function(n){var t={url:r.getDepositPayoutDetail.format({id:i.selectedJobEngagement.id}),method:"GET",headers:{"Content-Type":"application/json"}};$.ajax(t).done(n)};t.setDepositPayoutDetail=function(n){t.handleResponse(n,function(n){n.data.totalRemaining=n.data.deposit.totalAmount-n.data.payout.totalAmount;n.data.deposit.nextDueDate!==null&&(n.data.deposit.formattedNextDueDate=moment.utc(n.data.deposit.nextDueDate).local().format("DD/MM/YYYY"));$.observable(i.selectedJobEngagement).setProperty("depositPayout",n.data);t.loadPayoutRequestTable();t.loadDepositRequestTable();t.loadRefundRequestTable()})};t.reloadSelectedEngagement=function(n){n&&i.setSelectedJobEngagementStatus(n);t.getDepositPayoutDetail(t.setDepositPayoutDetail)};t.onJobApplicationStartDateUpdated=function(){i.selectedJobEngagement.isEscrow?i.selectedJobEngagement.jobType===3?$("#modal-project-deposit-request .modal-content").load(r.payProjectDepositRequest.format({id:i.selectedJobEngagement.id}),function(){$(this).addClass("content-loaded");$(this).closest(".modal").modal({show:!0})}):$("#modal-job-application-pay .modal-content").load(r.payJobEscrow,function(){$(this).addClass("content-loaded");$(this).closest(".modal").modal({show:!0})}):i.updateSelectedJobEngagementStatus("Hire",6)};t.getModel=function(){return i};t.setUserEvent=function(){o.on("click",".submit",function(n){n.preventDefault();n.stopPropagation();t.getJobEngagement(t.onGetJobEngagement)});o.on("click",".submit-refund",function(n){n.preventDefault();n.stopPropagation();swal({icon:"warning",title:"Are You Sure to Create Refund Request?",buttons:{cancel:{text:"Cancel",value:!1,visible:!0,className:"btn-secondary",closeModal:!0},confirm:{text:"Confirm",value:!0,visible:!0,className:"btn-primary",closeModal:!0}}}).then(function(n){n&&t.jobApplicationRefund(t.onJobApplicationRefunded)})})};s=function(){t.setData();$.templates.tmplContentJobEngagement.link(".content-job-engagement",i);t.initDisplayComponent();t.setUserEvent();t.getJobEngagement(t.onGetJobEngagement)};s()},pageJobApplicant=new PageJobApplicant({url:{getJobEngagement:"/api/pro/jobApplication/applicants",updateJobEngagementStatus:"/api/pro/jobApplication/{{id}}",getPayoutRequests:"/api/pro/payoutrequest/jobapplication/{{id}}",getDepositRequests:"/api/pro/depositrequest/jobapplication/{{id}}",getPayoutRequest:"/pro/payoutrequest/{{id}}",getDepositRequestStatement:"/pro/statement/Pdf/deposit/{{id}}",payJobEscrow:"/pro/order/payjobescrow",payProjectDepositRequest:"/pro/order/payProjectDepositRequest/{{id}}",payDepositRequest:"/pro/order/PayDepositRequest",getDepositPayoutDetail:"/api/pro/jobApplication/{{id}}/depositPayout",getRefundStatement:"/pro/statement/Pdf/Refund/{{id}}",getRefundRequests:"/api/pro/refundrequest/jobapplication/{{id}}",submitRefund:"/api/pro/jobApplication/{{id}}/refund"},msg:{keywordSearch:"search by keyword",info:"this is info"}});